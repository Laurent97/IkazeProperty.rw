module.exports=[25049,e=>{"use strict";var t=e.i(44070);class r{async createTransaction(e,r){let{data:a,error:n}=await t.supabaseAdmin.from("payment_transactions").insert({user_id:e.user_id,listing_id:e.listing_id,ad_campaign_id:e.ad_campaign_id,payment_method:e.payment_method,amount:e.amount,currency:e.currency||"RWF",transaction_type:e.transaction_type,status:"pending",provider_reference:r,description:e.description,metadata:e.metadata,expires_at:new Date(Date.now()+9e5)}).select().single();if(n)throw Error(`Failed to create payment transaction: ${n.message}`);return a}async updateTransactionStatus(e,r,a){let n={status:r,updated_at:new Date().toISOString()};"completed"===r&&(n.completed_at=new Date().toISOString()),a&&(n.provider_response=a);let{data:s,error:o}=await t.supabaseAdmin.from("payment_transactions").update(n).eq("our_reference",e).select().single();if(o)throw Error(`Failed to update transaction status: ${o.message}`);return s}async getTransaction(e){let{data:r,error:a}=await t.supabaseAdmin.from("payment_transactions").select("*").eq("our_reference",e).single();if(a){if("PGRST116"===a.code)return null;throw Error(`Failed to get transaction: ${a.message}`)}return r}async logWebhook(e,r,a){await t.supabaseAdmin.from("payment_webhook_logs").insert({payment_method:e,event_type:r,payload:a,status:"received"})}async markWebhookProcessed(e,r){await t.supabaseAdmin.from("payment_webhook_logs").update({processed:!0,error_message:r,status:r?"failed":"success"}).eq("id",e)}generateReference(){let e=Date.now(),t=Math.floor(1e6*Math.random()).toString().padStart(6,"0");return`${this.paymentMethod.toUpperCase()}${e}${t}`}calculateFees(e,t,r){return e*t/100+r}async getPaymentConfig(e){let{data:r,error:a}=await t.supabaseAdmin.from("payment_configurations").select("config_data, is_active").eq("payment_method",e).single();if(a)throw Error(`Failed to get payment configuration: ${a.message}`);if(!r.is_active)throw Error(`Payment method ${e} is not active`);return r.config_data}async getUserWallet(e){let{data:r,error:a}=await t.supabaseAdmin.from("user_wallets").select("*").eq("user_id",e).single();if(a)throw Error(`Failed to get user wallet: ${a.message}`);return r}async checkPaymentLimits(e,r,a="basic"){let{data:n,error:s}=await t.supabaseAdmin.from("payment_method_limits").select("*").eq("payment_method",e).eq("user_tier",a).single();if(s)throw Error(`Failed to get payment limits: ${s.message}`);if(r<n.min_amount)throw Error(`Minimum amount for ${e} is ${n.min_amount} RWF`);if(r>n.max_amount)throw Error(`Maximum amount for ${e} is ${n.max_amount} RWF`);let o=new Date().toISOString().split("T")[0],{data:i}=await t.supabaseAdmin.from("payment_transactions").select("amount").eq("payment_method",e).eq("status","completed").gte("created_at",o),c=i?.reduce((e,t)=>e+Number(t.amount),0)||0;if(c+r>n.daily_limit)throw Error(`Daily limit exceeded for ${e}. Remaining: ${n.daily_limit-c} RWF`);let u=new Date().toISOString().slice(0,7),{data:l}=await t.supabaseAdmin.from("payment_transactions").select("amount").eq("payment_method",e).eq("status","completed").gte("created_at",u),d=l?.reduce((e,t)=>e+Number(t.amount),0)||0;if(d+r>n.monthly_limit)throw Error(`Monthly limit exceeded for ${e}. Remaining: ${n.monthly_limit-d} RWF`)}}class a extends r{paymentMethod="mtn_momo";config=null;async getConfig(){if(this.config||(this.config=await this.getPaymentConfig("mtn_momo")),!this.config)throw Error("MTN Mobile Money configuration not found");return this.config}async initiatePayment(e){try{let t=await this.getConfig();if(!e.phone_number)throw Error("Phone number is required for MTN Mobile Money payments");await this.checkPaymentLimits("mtn_momo",e.amount);let r=this.calculateFees(e.amount,t.transaction_fee_percent,t.fixed_fee),a=e.amount+r,n=this.generateReference(),s=await this.createTransaction(e,n),o="production"===t.environment?"https://api.mtn.com/v1_0":"https://sandbox.mtn.com/v1_0",i={amount:a.toString(),currency:e.currency||"RWF",externalId:s.our_reference,payer:{partyIdType:"MSISDN",partyId:e.phone_number},payerMessage:e.description||`Payment for ${e.transaction_type}`,payeeNote:`IkazeProperty Payment - ${s.our_reference}`},c=await fetch(`${o}/requesttopay`,{method:"POST",headers:{"Ocp-Apim-Subscription-Key":t.api_key,"X-Reference-Id":s.our_reference,"Content-Type":"application/json","X-Target-Environment":t.environment},body:JSON.stringify(i)}),u=await c.json();return await this.updateTransactionStatus(s.our_reference,"pending",u),{success:!0,reference:s.our_reference,provider_reference:u.transactionId||s.our_reference,instructions:"Please check your phone for the MTN Mobile Money payment prompt",expires_at:s.expires_at}}catch(e){return console.error("MTN Mobile Money payment initiation failed:",e),{success:!1,reference:"",error:e.message||"Failed to initiate MTN Mobile Money payment"}}}async verifyPayment(e){try{let t=await this.getConfig(),r=await this.getTransaction(e);if(!r)return{success:!1,status:"failed",error:"Transaction not found"};if("completed"===r.status)return{success:!0,status:"completed",data:r.provider_response};if(r.expires_at&&new Date>new Date(r.expires_at))return await this.updateTransactionStatus(e,"expired"),{success:!1,status:"expired",error:"Transaction has expired"};let a="production"===t.environment?"https://api.mtn.com/v1_0":"https://sandbox.mtn.com/v1_0",n=await fetch(`${a}/requesttopay/${e}`,{headers:{"Ocp-Apim-Subscription-Key":t.api_key,"X-Target-Environment":t.environment}}),s=await n.json(),o=s.status;if("SUCCESSFUL"===o)return await this.updateTransactionStatus(e,"completed",s),{success:!0,status:"completed",data:s};if("FAILED"===o)return await this.updateTransactionStatus(e,"failed",s),{success:!1,status:"failed",data:s};return{success:!1,status:"pending",data:s}}catch(e){return console.error("MTN Mobile Money payment verification failed:",e),{success:!1,status:"failed",error:e.message||"Failed to verify payment"}}}async processWebhook(e){try{let t;await this.logWebhook("mtn_momo","payment_callback",e);let r=e.externalId,a=e.status;if(!r)throw Error("Missing externalId in webhook payload");switch(a){case"SUCCESSFUL":t="completed";break;case"FAILED":t="failed";break;case"EXPIRED":t="expired";break;default:t="pending"}if(await this.updateTransactionStatus(r,t,e),"completed"===t){let e=await this.getTransaction(r);e&&await this.handleSuccessfulPayment(e)}}catch(e){throw console.error("MTN Mobile Money webhook processing failed:",e),e}}async refundPayment(e){try{let r=await this.getConfig(),a=await this.getTransaction(e.original_transaction_id);if(!a)return{success:!1,status:"failed",error:"Original transaction not found"};if("completed"!==a.status)return{success:!1,status:"failed",error:"Cannot refund a non-completed transaction"};let n="production"===r.environment?"https://api.mtn.com/v1_0":"https://sandbox.mtn.com/v1_0",s={amount:e.amount||a.amount,currency:a.currency,externalId:`REFUND_${this.generateReference()}`,payerMessage:`Refund for transaction ${a.our_reference}`,payeeNote:e.reason},o=await fetch(`${n}/refund`,{method:"POST",headers:{"Ocp-Apim-Subscription-Key":r.api_key,"X-Reference-Id":s.externalId,"Content-Type":"application/json","X-Target-Environment":r.environment},body:JSON.stringify(s)});await o.json();let{data:i}=await t.supabaseAdmin.from("payment_refunds").insert({original_transaction_id:e.original_transaction_id,amount:e.amount||a.amount,reason:e.reason,status:"pending",processed_by:e.processed_by}).select().single();return{success:!0,refund_transaction_id:i.id,status:"pending"}}catch(e){return console.error("MTN Mobile Money refund failed:",e),{success:!1,status:"failed",error:e.message||"Failed to process refund"}}}async handleSuccessfulPayment(e){console.log("Payment successful:",e.our_reference),"ad_promotion"===e.transaction_type&&e.listing_id}}class n extends r{paymentMethod="airtel_money";config=null;async getConfig(){if(this.config||(this.config=await this.getPaymentConfig("airtel_money")),!this.config)throw Error("Airtel Money configuration not found");return this.config}async initiatePayment(e){try{let t=await this.getConfig();if(!e.phone_number)throw Error("Phone number is required for Airtel Money payments");await this.checkPaymentLimits("airtel_money",e.amount);let r=this.calculateFees(e.amount,t.transaction_fee_percent,t.fixed_fee),a=e.amount+r,n=this.generateReference(),s=await this.createTransaction(e,n);return console.log("Airtel Money payment initiated:",{reference:n,amount:a,phone:e.phone_number}),{success:!0,reference:s.our_reference,provider_reference:n,instructions:"Please check your phone for the Airtel Money payment prompt",expires_at:s.expires_at}}catch(e){return console.error("Airtel Money payment initiation failed:",e),{success:!1,reference:"",error:e.message||"Failed to initiate Airtel Money payment"}}}async verifyPayment(e){try{if(!await this.getTransaction(e))return{success:!1,status:"failed",error:"Transaction not found"};return{success:!1,status:"pending",data:{message:"Airtel Money verification not yet implemented"}}}catch(e){return console.error("Airtel Money payment verification failed:",e),{success:!1,status:"failed",error:e.message||"Failed to verify payment"}}}async processWebhook(e){try{await this.logWebhook("airtel_money","payment_callback",e),console.log("Airtel Money webhook received:",e)}catch(e){throw console.error("Airtel Money webhook processing failed:",e),e}}async refundPayment(e){try{return console.log("Airtel Money refund requested:",e),{success:!1,status:"failed",error:"Airtel Money refunds not yet implemented"}}catch(e){return console.error("Airtel Money refund failed:",e),{success:!1,status:"failed",error:e.message||"Failed to process refund"}}}}class s extends r{paymentMethod="equity_bank";config=null;async getConfig(){if(this.config||(this.config=await this.getPaymentConfig("equity_bank")),!this.config)throw Error("Equity Bank configuration not found");return this.config}async initiatePayment(e){try{let t=await this.getConfig();await this.checkPaymentLimits("equity_bank",e.amount);let r=this.calculateFees(e.amount,t.transaction_fee_percent,t.fixed_fee),a=e.amount+r,n=this.generateReference(),s=await this.createTransaction(e,n);return console.log("Equity Bank payment initiated:",{reference:n,amount:a,account:t.account_number}),{success:!0,reference:s.our_reference,provider_reference:n,instructions:`Please transfer ${a} RWF to Equity Bank account ${t.account_number} (${t.account_name}). Reference: ${s.our_reference}`,expires_at:s.expires_at}}catch(e){return console.error("Equity Bank payment initiation failed:",e),{success:!1,reference:"",error:e.message||"Failed to initiate Equity Bank payment"}}}async verifyPayment(e){try{if(!await this.getTransaction(e))return{success:!1,status:"failed",error:"Transaction not found"};return{success:!1,status:"pending",data:{message:"Equity Bank verification not yet implemented"}}}catch(e){return console.error("Equity Bank payment verification failed:",e),{success:!1,status:"failed",error:e.message||"Failed to verify payment"}}}async processWebhook(e){try{await this.logWebhook("equity_bank","payment_callback",e),console.log("Equity Bank webhook received:",e)}catch(e){throw console.error("Equity Bank webhook processing failed:",e),e}}async refundPayment(e){try{return console.log("Equity Bank refund requested:",e),{success:!1,status:"failed",error:"Equity Bank refunds not yet implemented"}}catch(e){return console.error("Equity Bank refund failed:",e),{success:!1,status:"failed",error:e.message||"Failed to process refund"}}}}class o extends r{paymentMethod="crypto";config=null;async getConfig(){if(this.config||(this.config=await this.getPaymentConfig("crypto")),!this.config)throw Error("Crypto configuration not found");return this.config}async getExchangeRate(e,r){let{data:a,error:n}=await t.supabaseAdmin.from("exchange_rates").select("rate").eq("from_currency",e).eq("to_currency",r).eq("source","coinbase").single();if(n)throw Error(`Failed to get exchange rate: ${n.message}`);return a.rate}async convertToCrypto(e,t){let r=await this.getConfig();if("manual"===r.exchange_rate_provider&&r.manual_exchange_rate){let a=e/r.manual_exchange_rate;switch(t){case"bitcoin":return a/45e3;case"ethereum":return a/2500;case"usdt":return a;default:throw Error(`Unsupported crypto type: ${t}`)}}return e/await this.getExchangeRate("USD","RWF")/await this.getExchangeRate(t.toUpperCase(),"USD")}getCryptoWalletAddress(e){if(!this.config)throw Error("Crypto configuration not loaded");switch(e){case"bitcoin":return this.config.bitcoin.wallet_address;case"ethereum":return this.config.ethereum.wallet_address;case"usdt":return this.config.usdt.wallet_address;default:throw Error(`Unsupported crypto type: ${e}`)}}generateQRCode(e,t){let r=`<svg width="200" height="200" xmlns="http://www.w3.org/2000/svg">
      <rect width="200" height="200" fill="white"/>
      <text x="100" y="100" text-anchor="middle" font-size="12">QR Code</text>
      <text x="100" y="120" text-anchor="middle" font-size="8">${e.substring(0,20)}...</text>
    </svg>`;return`data:image/svg+xml;base64,${Buffer.from(r).toString("base64")}`}async initiatePayment(e){try{let t=await this.getConfig();if(!e.crypto_type)throw Error("Crypto type is required for crypto payments");if(!t[e.crypto_type].enabled)throw Error(`${e.crypto_type} payments are not enabled`);await this.checkPaymentLimits("crypto",e.amount);let r=await this.convertToCrypto(e.amount,e.crypto_type),a=this.getCryptoWalletAddress(e.crypto_type),n=this.generateReference(),s=await this.createTransaction(e,n),o=this.generateQRCode(a,r);return{success:!0,reference:s.our_reference,wallet_address:a,crypto_amount:r,crypto_currency:e.crypto_type.toUpperCase(),qr_code_url:o,exchange_rate:await this.getExchangeRate(e.crypto_type.toUpperCase(),"RWF"),instructions:`Please send ${r} ${e.crypto_type.toUpperCase()} to the provided address`,expires_at:s.expires_at}}catch(e){return console.error("Crypto payment initiation failed:",e),{success:!1,reference:"",error:e.message||"Failed to initiate crypto payment"}}}async verifyPayment(e){try{let t=await this.getTransaction(e);if(!t)return{success:!1,status:"failed",error:"Transaction not found"};if(t.expires_at&&new Date>new Date(t.expires_at))return await this.updateTransactionStatus(e,"expired"),{success:!1,status:"expired",error:"Transaction has expired"};return{success:!1,status:"pending",data:{message:"Crypto payment verification not yet implemented"}}}catch(e){return console.error("Crypto payment verification failed:",e),{success:!1,status:"failed",error:e.message||"Failed to verify crypto payment"}}}async processWebhook(e){try{await this.logWebhook("crypto","payment_callback",e),console.log("Crypto webhook received:",e)}catch(e){throw console.error("Crypto webhook processing failed:",e),e}}async refundPayment(e){try{return console.log("Crypto refund requested:",e),{success:!1,status:"failed",error:"Crypto refunds not yet implemented"}}catch(e){return console.error("Crypto refund failed:",e),{success:!1,status:"failed",error:e.message||"Failed to process crypto refund"}}}}class i extends r{paymentMethod="wallet";async initiatePayment(e){try{let t=await this.getUserWallet(e.user_id);if(t.balance<e.amount)return{success:!1,reference:"",error:`Insufficient wallet balance. Available: ${t.balance} RWF, Required: ${e.amount} RWF`};let r=await this.createTransaction(e);return await this.updateTransactionStatus(r.our_reference,"completed"),{success:!0,reference:r.our_reference,instructions:"Payment completed successfully using wallet balance"}}catch(e){return console.error("Wallet payment initiation failed:",e),{success:!1,reference:"",error:e.message||"Failed to process wallet payment"}}}async verifyPayment(e){try{let t=await this.getTransaction(e);if(!t)return{success:!1,status:"failed",error:"Transaction not found"};return{success:!0,status:t.status,data:t}}catch(e){return console.error("Wallet payment verification failed:",e),{success:!1,status:"failed",error:e.message||"Failed to verify wallet payment"}}}async processWebhook(e){console.log("Wallet webhook received (unexpected):",e)}async refundPayment(e){try{let r=await this.getTransaction(e.original_transaction_id);if(!r)return{success:!1,status:"failed",error:"Original transaction not found"};if("completed"!==r.status)return{success:!1,status:"failed",error:"Cannot refund a non-completed transaction"};let a=await this.createTransaction({user_id:r.user_id,payment_method:"wallet",amount:e.amount||r.amount,currency:r.currency,transaction_type:"refund",description:`Refund for transaction ${r.our_reference}: ${e.reason}`,metadata:{original_transaction_id:r.id,refund_reason:e.reason}});await this.updateTransactionStatus(a.our_reference,"completed");let{data:n}=await t.supabaseAdmin.from("payment_refunds").insert({original_transaction_id:e.original_transaction_id,refund_transaction_id:a.id,amount:e.amount||r.amount,reason:e.reason,status:"completed",processed_by:e.processed_by,processed_at:new Date().toISOString()}).select().single();return{success:!0,refund_transaction_id:n.id,status:"completed"}}catch(e){return console.error("Wallet refund failed:",e),{success:!1,status:"failed",error:e.message||"Failed to process wallet refund"}}}}class c{static processors=new Map;static createProcessor(e){let t;if(this.processors.has(e))return this.processors.get(e);switch(e){case"mtn_momo":t=new a;break;case"airtel_money":t=new n;break;case"equity_bank":t=new s;break;case"crypto":t=new o;break;case"wallet":t=new i;break;default:throw Error(`Unsupported payment method: ${e}`)}return this.processors.set(e,t),t}static async initiatePayment(e){let t=this.createProcessor(e.payment_method);return await t.initiatePayment(e)}static async verifyPayment(e,t){let r=this.createProcessor(e);return await r.verifyPayment(t)}static async processWebhook(e,t){let r=this.createProcessor(e);return await r.processWebhook(t)}static async refundPayment(e,t){let r=this.createProcessor(e);return await r.refundPayment(t)}static getSupportedMethods(){return["mtn_momo","airtel_money","equity_bank","crypto","wallet"]}static async isMethodAvailable(e){try{return this.createProcessor(e),!0}catch(t){return console.error(`Payment method ${e} not available:`,t),!1}}}e.s(["PaymentProcessorFactory",()=>c],25049)}];

//# sourceMappingURL=src_lib_payment_factory_ts_e18f561a._.js.map