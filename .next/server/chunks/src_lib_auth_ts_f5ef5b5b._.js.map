{"version":3,"sources":["../../../src/lib/auth.ts","../../../src/lib/supabase-client.ts"],"sourcesContent":["import { createClient } from '@supabase/supabase-js'\nimport { Database } from '@/types/database'\nimport { getSupabaseClient } from '@/lib/supabase-client'\n\nlet _supabaseAdmin: ReturnType<typeof createClient<Database>> | null = null\nlet _supabaseAuth: ReturnType<typeof createClient<Database>> | null = null\n\nexport const getSupabaseAdmin = () => {\n  if (!_supabaseAdmin) {\n    const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL\n    const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY\n\n    if (!supabaseUrl || !supabaseServiceKey) {\n      throw new Error('Missing Supabase environment variables. Please check your .env.local file.')\n    }\n\n    _supabaseAdmin = createClient<Database>(supabaseUrl, supabaseServiceKey)\n  }\n  return _supabaseAdmin\n}\n\nexport const getSupabaseAuth = () => {\n  if (!_supabaseAuth) {\n    const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL\n    const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY\n\n    if (!supabaseUrl || !supabaseServiceKey) {\n      throw new Error('Missing Supabase environment variables. Please check your .env.local file.')\n    }\n\n    _supabaseAuth = createClient<Database>(supabaseUrl, supabaseServiceKey)\n  }\n  return _supabaseAuth\n}\n\nexport const supabase = getSupabaseClient()\n\n// For backward compatibility, export the getter functions with the same names\nexport const supabaseAdmin = getSupabaseAdmin\nexport const supabaseAuth = getSupabaseAuth\n\nexport const signUp = async (email: string, password: string, fullName: string) => {\n  const response = await fetch('/api/auth/register', {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json',\n    },\n    body: JSON.stringify({\n      email,\n      password,\n      fullName\n    })\n  })\n\n  const data = await response.json()\n\n  if (!response.ok) {\n    throw new Error(data.error || 'Registration failed')\n  }\n\n  return data\n}\n\nexport const signIn = async (email: string, password: string) => {\n  const { data, error } = await supabase.auth.signInWithPassword({\n    email,\n    password\n  })\n\n  if (error) throw error\n  return data\n}\n\nexport const signOut = async () => {\n  const { error } = await supabase.auth.signOut()\n  if (error) throw error\n}\n\nexport const getCurrentUser = async () => {\n  const { data: { user }, error } = await supabase.auth.getUser()\n  if (error) throw error\n  return user\n}\n\nexport const getUserProfile = async (userId: string) => {\n  const { data, error } = await supabase\n    .from('users')\n    .select('*')\n    .eq('id', userId)\n    .single()\n\n  if (error && error.code !== 'PGRST116') { // PGRST116 is the error code for \"no rows returned\"\n    throw error\n  }\n  return data\n}\n\nexport const updateUserProfile = async (userId: string, updates: any) => {\n  const authClient = supabaseAuth()\n  const { data, error } = await (authClient as any)\n    .from('users')\n    .update(updates)\n    .eq('id', userId)\n    .select()\n    .single()\n\n  if (error) throw error\n  return data\n}\n\nexport const resetPassword = async (email: string) => {\n  const response = await fetch('/api/auth/reset-password', {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json',\n    },\n    body: JSON.stringify({ email })\n  })\n\n  const data = await response.json()\n\n  if (!response.ok) {\n    throw new Error(data.error || 'Failed to send reset email')\n  }\n\n  return data\n}\n\nexport const updatePassword = async (password: string) => {\n  // Get current session to get the access token\n  const { data: { session } } = await supabase.auth.getSession()\n  \n  if (!session?.access_token) {\n    throw new Error('No active session found. Please log in again.')\n  }\n\n  const response = await fetch('/api/auth/update-password', {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json',\n      'Authorization': `Bearer ${session.access_token}`\n    },\n    body: JSON.stringify({ password })\n  })\n\n  const data = await response.json()\n\n  if (!response.ok) {\n    throw new Error(data.error || 'Failed to update password')\n  }\n\n  return data\n}\n\nexport const signInWithGoogle = async () => {\n  const { data, error } = await supabase.auth.signInWithOAuth({\n    provider: 'google',\n    options: {\n      redirectTo: `${window.location.origin}/auth/callback`\n    }\n  })\n\n  if (error) throw error\n  return data\n}\n\nexport const signInWithMagicLink = async (email: string) => {\n  const { data, error } = await supabase.auth.signInWithOtp({\n    email,\n    options: {\n      emailRedirectTo: `${window.location.origin}/auth/callback`\n    }\n  })\n\n  if (error) throw error\n  return data\n}\n\nexport const changeUserEmail = async (newEmail: string) => {\n  const { data, error } = await supabase.auth.updateUser({\n    email: newEmail\n  })\n\n  if (error) throw error\n  return data\n}\n","import { createClient } from '@supabase/supabase-js'\nimport { Database } from '@/types/database'\n\nlet supabaseClient: ReturnType<typeof createClient<Database>> | null = null\n\nexport const getSupabaseClient = () => {\n  if (!supabaseClient) {\n    const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL\n    const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY\n\n    if (!supabaseUrl || !supabaseAnonKey) {\n      console.error('Missing Supabase environment variables:', {\n        url: !!supabaseUrl,\n        key: !!supabaseAnonKey\n      })\n      throw new Error('Missing Supabase environment variables. Please check your .env.local file.')\n    }\n\n    // Create a single Supabase client for the entire app\n    supabaseClient = createClient<Database>(supabaseUrl, supabaseAnonKey, {\n      auth: {\n        persistSession: true,\n        autoRefreshToken: true,\n        detectSessionInUrl: true,\n        storage: typeof window !== 'undefined' ? window.localStorage : undefined,\n        flowType: 'pkce',\n      },\n      global: {\n        headers: {\n          'Accept': 'application/json',\n          'Content-Type': 'application/json',\n        }\n      },\n      db: {\n        schema: 'public'\n      }\n    })\n  }\n  return supabaseClient\n}\n\n// Export as default for backward compatibility\nexport default getSupabaseClient()\n\n// Helper function to fetch listings with proper error handling\nexport async function fetchListingsWithDetails(filters: {\n  category?: string;\n  searchQuery?: string;\n  priceRange?: { min?: string; max?: string };\n  subcategory?: string;\n  condition?: string;\n  sortBy?: string;\n  limit?: number;\n}) {\n  try {\n    const {\n      category = 'other',\n      searchQuery = '',\n      priceRange = {},\n      subcategory = '',\n      condition = '',\n      sortBy = 'created_at',\n      limit = 50\n    } = filters\n\n    let query = getSupabaseClient()\n      .from('listings')\n      .select(`\n        *,\n        seller:users!listings_seller_id_fkey(\n          id,\n          full_name,\n          email,\n          avatar_url\n        )\n      `)\n      .eq('status', 'available')\n      .eq('category', category)\n\n    // Apply text search\n    if (searchQuery.trim()) {\n      query = query.or(`title.ilike.%${searchQuery}%,description.ilike.%${searchQuery}%`)\n    }\n\n    // Apply price range\n    if (priceRange.min) {\n      const min = parseInt(priceRange.min) || 0\n      query = query.gte('price', min)\n    }\n    if (priceRange.max) {\n      const max = parseInt(priceRange.max) || 1000000000\n      query = query.lte('price', max)\n    }\n\n    // Apply sorting\n    switch (sortBy) {\n      case 'price':\n        query = query.order('price', { ascending: true })\n        break\n      case 'price_desc':\n        query = query.order('price', { ascending: false })\n        break\n      case 'views':\n        query = query.order('views', { ascending: false })\n        break\n      case 'likes':\n        query = query.order('likes', { ascending: false })\n        break\n      default:\n        query = query.order('created_at', { ascending: false })\n    }\n\n    query = query.limit(limit)\n\n    const { data: listings, error: listingsError } = await query\n\n    if (listingsError) {\n      console.error('Error fetching listings:', listingsError)\n      return { listings: [], error: listingsError }\n    }\n\n    if (!listings || listings.length === 0) {\n      return { listings: [] }\n    }\n\n    // Fetch additional data in parallel\n    const listingIds = (listings as any[]).map(l => l.id)\n    \n    const [mediaResult, detailsResult] = await Promise.all([\n      getSupabaseClient()\n        .from('listing_media')\n        .select('*')\n        .in('listing_id', listingIds)\n        .order('order_index', { ascending: true }),\n      getSupabaseClient()\n        .from('other_item_details')\n        .select('*')\n        .in('listing_id', listingIds)\n    ])\n\n    // Process the data\n    const listingsWithDetails = (listings as any[]).map(listing => {\n      const listingMedia = mediaResult.data?.filter((m: any) => m.listing_id === listing.id) || []\n      const listingDetails = detailsResult.data?.find((d: any) => d.listing_id === listing.id)\n\n      return {\n        ...listing,\n        media: listingMedia.map((media: any) => ({\n          url: media.url,\n          public_id: media.public_id,\n          media_type: media.media_type,\n          is_primary: media.is_primary,\n          order_index: media.order_index\n        })),\n        other_details: listingDetails ? {\n          subcategory: (listingDetails as any).subcategory,\n          brand: (listingDetails as any).brand,\n          model: (listingDetails as any).model,\n          condition: (listingDetails as any).condition,\n          warranty_available: (listingDetails as any).warranty_available,\n          warranty_period: (listingDetails as any).warranty_period,\n          reason_for_selling: (listingDetails as any).reason_for_selling,\n          original_purchase_date: (listingDetails as any).original_purchase_date,\n          age_of_item: (listingDetails as any).age_of_item\n        } : undefined\n      }\n    })\n\n    // Apply additional filters after fetching\n    let filteredListings = listingsWithDetails\n    \n    if (subcategory) {\n      filteredListings = filteredListings.filter(l => \n        l.other_details?.subcategory === subcategory\n      )\n    }\n    \n    if (condition) {\n      filteredListings = filteredListings.filter(l => \n        l.other_details?.condition === condition\n      )\n    }\n\n    return { listings: filteredListings }\n  } catch (error) {\n    console.error('Error in fetchListingsWithDetails:', error)\n    return { listings: [], error }\n  }\n}\n"],"names":[],"mappings":"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"}