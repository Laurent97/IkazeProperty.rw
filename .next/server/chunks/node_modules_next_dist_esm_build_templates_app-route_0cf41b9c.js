module.exports=[91126,e=>{"use strict";var t=e.i(47909),r=e.i(74017),o=e.i(96250),a=e.i(59756),s=e.i(61916),i=e.i(74677),n=e.i(69741),l=e.i(16795),d=e.i(87718),c=e.i(95169),u=e.i(47587),g=e.i(66012),p=e.i(70101),h=e.i(26937),f=e.i(10372),_=e.i(93695);e.i(52474);var m=e.i(5232),y=e.i(89171),R=e.i(24389);async function v(e){try{let t="https://swshkufpktnacbotddpb.supabase.co",r=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!t||!r)return y.NextResponse.json({error:"Missing environment variables"},{status:500});let o=(0,R.createClient)(t,r),{searchParams:a}=new URL(e.url),s=a.get("category"),i=parseInt(a.get("limit")||"10"),n=parseInt(a.get("offset")||"0");console.log("ðŸ“ Fetching listings with params:",{category:s,limit:i,offset:n});let l=o.from("listings").select(`
        id,
        title,
        price,
        currency,
        category,
        status,
        created_at,
        promoted,
        featured,
        seller_id:users(id, full_name, email),
        listing_media(
          id,
          url,
          media_type,
          order_index,
          is_primary
        ),
        listing_promotions(
          id,
          promotion_type,
          status,
          starts_at,
          expires_at
        )
      `).eq("status","available").order("promoted",{ascending:!1}).order("featured",{ascending:!1}).order("created_at",{ascending:!1}).range(n,n+i-1);s&&"all"!==s&&(l=l.eq("category",s));let{data:d,error:c}=await l;if(c)return console.error("âŒ Error fetching listings:",c),y.NextResponse.json({error:c.message},{status:500});return console.log(`âœ… Found ${d?.length||0} listings`),y.NextResponse.json({success:!0,data:d||[],count:d?.length||0})}catch(e){return console.error("âŒ Get listings error:",e),y.NextResponse.json({error:e.message||"Failed to fetch listings"},{status:500})}}async function E(e){try{let t="https://swshkufpktnacbotddpb.supabase.co",r=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!t||!r)return y.NextResponse.json({error:"Missing environment variables"},{status:500});let o=(0,R.createClient)(t,r),a=e.headers.get("authorization");if(!a)return console.log("No authorization header found"),y.NextResponse.json({error:"Authorization header required"},{status:401});let s=a.replace("Bearer ",""),{data:{user:i},error:n}=await o.auth.getUser(s);if(n||!i)return console.error("Token verification failed:",n),y.NextResponse.json({error:"Invalid or expired token",details:n?.message},{status:401});console.log("âœ… Authenticated user:",i.email);let l=await e.json();console.log("ðŸ“ Received body:",l),console.log("ðŸš— Car details in API:",l.car_details),console.log("ðŸ  House details in API:",l.house_details),console.log("ðŸŒ³ Land details in API:",l.land_details),console.log("ðŸ“¦ Other details in API:",l.other_details);let{title:d,description:c,price:u,currency:g,price_type:p,category:h,transaction_type:f,location:_,seller_id:m,visit_fee_enabled:v,visit_fee_amount:E,visit_fee_payment_methods:C,commission_rate:w=.3,commission_agreed:x,featured:b=!1,promoted:N=!1}=l,A=.3;"owner"===l.commission_type?A=.02:"agent"===l.commission_type&&(A=.3),console.log("ðŸ” Validating fields:"),console.log("- title:",d),console.log("- description:",c),console.log("- price:",u),console.log("- category:",h),console.log("- seller_id:",m),console.log("- commission_type:",l.commission_type),console.log("- commission_rate:",A);let k=[{key:"title",label:"Title"},{key:"description",label:"Description"},{key:"price",label:"Price"},{key:"category",label:"Category"},{key:"seller_id",label:"Seller ID"}].filter(e=>!l[e.key]).map(e=>e.label);if(k.length>0)return console.error("âŒ Missing required fields:",k),y.NextResponse.json({error:"Missing required fields",missingFields:k,details:`Please provide: ${k.join(", ")}`},{status:400});if(isNaN(parseFloat(l.price))||0>=parseFloat(l.price))return console.error("âŒ Invalid price:",l.price),y.NextResponse.json({error:"Price must be a valid positive number"},{status:400});let{data:P,error:S}=await o.from("users").select("id").eq("id",i.id).single();if(S||!P)return console.error("âŒ User not found in users table:",S),y.NextResponse.json({error:"User profile not found. Please complete your profile first."},{status:400});if(console.log("âœ… User verified in users table:",P.id),m&&m!==i.id)return y.NextResponse.json({error:"Cannot create listing for another user"},{status:403});let{data:O,error:T}=await o.from("listings").insert({title:d,description:c,price:parseFloat(u),currency:g||"RWF",price_type:p,category:h,transaction_type:f,status:"available",location:_,seller_id:i.id,commission_rate:A,commission_agreed:x,featured:b,promoted:N,views:0,likes:0,visit_fee_enabled:v??!0,visit_fee_amount:E??15e3,visit_fee_payment_methods:C??{}}).select().single();if(T)return console.error("Listing creation error:",T),y.NextResponse.json({error:T.message},{status:500});if(console.log("ðŸ” Checking category:",l.category),console.log("ðŸ” Has car details:",!!l.car_details),"cars"===l.category&&l.car_details){console.log("ðŸš— Creating car details for listing:",O.id),console.log("ðŸš— Car details data:",l.car_details);try{let{data:e,error:t}=await o.from("car_details").insert({listing_id:O.id,...l.car_details}).select().single();t?console.error("Car details creation error:",t):console.log("âœ… Car details created:",e)}catch(e){console.error("Error creating car details:",e)}}else console.log("ðŸš— Skipping car details - category:",l.category,"has data:",!!l.car_details);if(console.log("ðŸ” Checking house details - category:",l.category,"has data:",!!l.house_details),"houses"===l.category&&l.house_details){console.log("ðŸ  Creating house details for listing:",O.id),console.log("ðŸ  House details data:",l.house_details);try{let{data:e,error:t}=await o.from("house_details").insert({listing_id:O.id,...l.house_details}).select().single();t?console.error("House details creation error:",t):console.log("âœ… House details created:",e)}catch(e){console.error("Error creating house details:",e)}}else console.log("ðŸ  Skipping house details - category:",l.category,"has data:",!!l.house_details);if(console.log("ðŸ” Checking land details - category:",l.category,"has data:",!!l.land_details),"land"===l.category&&l.land_details){console.log("ðŸŒ³ Creating land details for listing:",O.id),console.log("ðŸŒ³ Land details data:",l.land_details);try{let{data:e,error:t}=await o.from("land_details").insert({listing_id:O.id,...l.land_details}).select().single();t?console.error("Land details creation error:",t):console.log("âœ… Land details created:",e)}catch(e){console.error("Error creating land details:",e)}}else console.log("ðŸŒ³ Skipping land details - category:",l.category,"has data:",!!l.land_details);if(console.log("ðŸ” Checking other details - category:",l.category,"has data:",!!l.other_details),"other"===l.category&&l.other_details){console.log("ðŸ“¦ Creating other item details for listing:",O.id),console.log("ðŸ“¦ Other details data:",l.other_details);try{let{data:e,error:t}=await o.from("other_item_details").insert({listing_id:O.id,...l.other_details}).select().single();t?console.error("Other details creation error:",t):console.log("âœ… Other details created:",e)}catch(e){console.error("Error creating other details:",e)}}else console.log("ðŸ“¦ Skipping other details - category:",l.category,"has data:",!!l.other_details);return y.NextResponse.json({success:!0,data:O})}catch(e){return console.error("Create listing error:",e),y.NextResponse.json({error:e.message||"Failed to create listing"},{status:500})}}e.s(["GET",()=>v,"POST",()=>E],64545);var C=e.i(64545);let w=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/listings/route",pathname:"/api/listings",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/listings/route.ts",nextConfigOutput:"",userland:C}),{workAsyncStorage:x,workUnitAsyncStorage:b,serverHooks:N}=w;function A(){return(0,o.patchFetch)({workAsyncStorage:x,workUnitAsyncStorage:b})}async function k(e,t,o){w.isDev&&(0,a.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let y="/api/listings/route";y=y.replace(/\/index$/,"")||"/";let R=await w.prepare(e,t,{srcPage:y,multiZoneDraftMode:!1});if(!R)return t.statusCode=400,t.end("Bad Request"),null==o.waitUntil||o.waitUntil.call(o,Promise.resolve()),null;let{buildId:v,params:E,nextConfig:C,parsedUrl:x,isDraftMode:b,prerenderManifest:N,routerServerContext:A,isOnDemandRevalidate:k,revalidateOnlyGenerated:P,resolvedPathname:S,clientReferenceManifest:O,serverActionsManifest:T}=R,I=(0,n.normalizeAppPath)(y),j=!!(N.dynamicRoutes[I]||N.routes[S]),U=async()=>((null==A?void 0:A.render404)?await A.render404(e,t,x,!1):t.end("This page could not be found"),null);if(j&&!b){let e=!!N.routes[S],t=N.dynamicRoutes[I];if(t&&!1===t.fallback&&!e){if(C.experimental.adapterPath)return await U();throw new _.NoFallbackError}}let H=null;!j||w.isDev||b||(H="/index"===(H=S)?"/":H);let q=!0===w.isDev||!j,F=j&&!q;T&&O&&(0,i.setManifestsSingleton)({page:y,clientReferenceManifest:O,serverActionsManifest:T});let M=e.method||"GET",D=(0,s.getTracer)(),L=D.getActiveScopeSpan(),$={params:E,prerenderManifest:N,renderOpts:{experimental:{authInterrupts:!!C.experimental.authInterrupts},cacheComponents:!!C.cacheComponents,supportsDynamicResponse:q,incrementalCache:(0,a.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:C.cacheLife,waitUntil:o.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,o,a)=>w.onRequestError(e,t,o,a,A)},sharedContext:{buildId:v}},K=new l.NodeNextRequest(e),B=new l.NodeNextResponse(t),V=d.NextRequestAdapter.fromNodeNextRequest(K,(0,d.signalFromNodeResponse)(t));try{let i=async e=>w.handle(V,$).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=D.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let o=r.get("next.route");if(o){let t=`${M} ${o}`;e.setAttributes({"next.route":o,"http.route":o,"next.span_name":t}),e.updateName(t)}else e.updateName(`${M} ${y}`)}),n=!!(0,a.getRequestMeta)(e,"minimalMode"),l=async a=>{var s,l;let d=async({previousCacheEntry:r})=>{try{if(!n&&k&&P&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let s=await i(a);e.fetchMetrics=$.renderOpts.fetchMetrics;let l=$.renderOpts.pendingWaitUntil;l&&o.waitUntil&&(o.waitUntil(l),l=void 0);let d=$.renderOpts.collectedTags;if(!j)return await (0,g.sendResponse)(K,B,s,$.renderOpts.pendingWaitUntil),null;{let e=await s.blob(),t=(0,p.toNodeOutgoingHttpHeaders)(s.headers);d&&(t[f.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==$.renderOpts.collectedRevalidate&&!($.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&$.renderOpts.collectedRevalidate,o=void 0===$.renderOpts.collectedExpire||$.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:$.renderOpts.collectedExpire;return{value:{kind:m.CachedRouteKind.APP_ROUTE,status:s.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:o}}}}catch(t){throw(null==r?void 0:r.isStale)&&await w.onRequestError(e,t,{routerKind:"App Router",routePath:y,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:F,isOnDemandRevalidate:k})},!1,A),t}},c=await w.handleResponse({req:e,nextConfig:C,cacheKey:H,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:N,isRoutePPREnabled:!1,isOnDemandRevalidate:k,revalidateOnlyGenerated:P,responseGenerator:d,waitUntil:o.waitUntil,isMinimalMode:n});if(!j)return null;if((null==c||null==(s=c.value)?void 0:s.kind)!==m.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(l=c.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});n||t.setHeader("x-nextjs-cache",k?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),b&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let _=(0,p.fromNodeOutgoingHttpHeaders)(c.value.headers);return n&&j||_.delete(f.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||_.get("Cache-Control")||_.set("Cache-Control",(0,h.getCacheControlHeader)(c.cacheControl)),await (0,g.sendResponse)(K,B,new Response(c.value.body,{headers:_,status:c.value.status||200})),null};L?await l(L):await D.withPropagatedContext(e.headers,()=>D.trace(c.BaseServerSpan.handleRequest,{spanName:`${M} ${y}`,kind:s.SpanKind.SERVER,attributes:{"http.method":M,"http.target":e.url}},l))}catch(t){if(t instanceof _.NoFallbackError||await w.onRequestError(e,t,{routerKind:"App Router",routePath:I,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:F,isOnDemandRevalidate:k})},!1,A),j)throw t;return await (0,g.sendResponse)(K,B,new Response(null,{status:500})),null}}e.s(["handler",()=>k,"patchFetch",()=>A,"routeModule",()=>w,"serverHooks",()=>N,"workAsyncStorage",()=>x,"workUnitAsyncStorage",()=>b],91126)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_0cf41b9c.js.map