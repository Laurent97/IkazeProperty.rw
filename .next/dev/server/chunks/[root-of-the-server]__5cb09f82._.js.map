{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///D:/Apps/IkazeProperty.rw/src/app/api/listings/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\nimport { createClient } from '@supabase/supabase-js'\n\nexport async function GET(request: NextRequest) {\n  try {\n    // Create Supabase client with service role key for admin operations\n    const supabase = createClient(\n      process.env.NEXT_PUBLIC_SUPABASE_URL!,\n      process.env.SUPABASE_SERVICE_ROLE_KEY!\n    )\n\n    // Get query parameters\n    const { searchParams } = new URL(request.url)\n    const category = searchParams.get('category')\n    const limit = parseInt(searchParams.get('limit') || '10')\n    const offset = parseInt(searchParams.get('offset') || '0')\n\n    console.log('üìù Fetching listings with params:', { category, limit, offset })\n\n    // Build query\n    let query = supabase\n      .from('listings')\n      .select(`\n        id,\n        title,\n        price,\n        currency,\n        category,\n        status,\n        created_at,\n        seller_id:users(id, full_name, email),\n        listing_media(\n          id,\n          url,\n          media_type,\n          order_index,\n          is_primary\n        )\n      `)\n      .eq('status', 'available')\n      .order('created_at', { ascending: false })\n      .range(offset, offset + limit - 1)\n\n    // Add category filter if provided\n    if (category && category !== 'all') {\n      query = query.eq('category', category)\n    }\n\n    const { data: listings, error } = await query\n\n    if (error) {\n      console.error('‚ùå Error fetching listings:', error)\n      return NextResponse.json(\n        { error: error.message },\n        { status: 500 }\n      )\n    }\n\n    console.log(`‚úÖ Found ${listings?.length || 0} listings`)\n\n    return NextResponse.json({\n      success: true,\n      data: listings || [],\n      count: listings?.length || 0\n    })\n\n  } catch (error: any) {\n    console.error('‚ùå Get listings error:', error)\n    return NextResponse.json(\n      { error: error.message || 'Failed to fetch listings' },\n      { status: 500 }\n    )\n  }\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    // Create Supabase client with service role key for admin operations\n    const supabase = createClient(\n      process.env.NEXT_PUBLIC_SUPABASE_URL!,\n      process.env.SUPABASE_SERVICE_ROLE_KEY!\n    )\n\n    // Get JWT token from request headers\n    const authorization = request.headers.get('authorization')\n    if (!authorization) {\n      console.log('No authorization header found')\n      return NextResponse.json(\n        { error: 'Authorization header required' },\n        { status: 401 }\n      )\n    }\n\n    const token = authorization.replace('Bearer ', '')\n    \n    // Verify the JWT token and get user\n    const { data: { user }, error: authError } = await supabase.auth.getUser(token)\n    \n    if (authError || !user) {\n      console.error('Token verification failed:', authError)\n      return NextResponse.json(\n        { error: 'Invalid or expired token', details: authError?.message },\n        { status: 401 }\n      )\n    }\n\n    console.log('‚úÖ Authenticated user:', user.email)\n\n    const body = await request.json()\n    console.log('üìù Received body:', body)\n    \n    const { \n      title, \n      description, \n      price, \n      currency, \n      price_type, \n      category, \n      transaction_type, \n      location, \n      seller_id,\n      visit_fee_enabled,\n      visit_fee_amount,\n      visit_fee_payment_methods,\n      commission_rate = 0.30,\n      commission_agreed,\n      featured = false,\n      promoted = false \n    } = body\n\n    console.log('üîç Validating fields:')\n    console.log('- title:', title)\n    console.log('- description:', description)\n    console.log('- price:', price)\n    console.log('- category:', category)\n    console.log('- seller_id:', seller_id)\n\n    // Validate required fields with better error messages\n    const requiredFields = [\n      { key: 'title', label: 'Title' },\n      { key: 'description', label: 'Description' },\n      { key: 'price', label: 'Price' },\n      { key: 'category', label: 'Category' },\n      { key: 'seller_id', label: 'Seller ID' }\n    ]\n    \n    const missingFields = requiredFields\n      .filter(field => !body[field.key])\n      .map(field => field.label)\n    \n    if (missingFields.length > 0) {\n      console.error('‚ùå Missing required fields:', missingFields)\n      return NextResponse.json(\n        { \n          error: 'Missing required fields',\n          missingFields: missingFields,\n          details: `Please provide: ${missingFields.join(', ')}` \n        },\n        { status: 400 }\n      )\n    }\n\n    // Also validate price is a valid number\n    if (isNaN(parseFloat(body.price)) || parseFloat(body.price) <= 0) {\n      console.error('‚ùå Invalid price:', body.price)\n      return NextResponse.json(\n        { error: 'Price must be a valid positive number' },\n        { status: 400 }\n      )\n    }\n\n    // Ensure the user exists in the users table\n    const { data: existingUser, error: userCheckError } = await supabase\n      .from('users')\n      .select('id')\n      .eq('id', user.id)\n      .single()\n    \n    if (userCheckError || !existingUser) {\n      console.error('‚ùå User not found in users table:', userCheckError)\n      return NextResponse.json(\n        { error: 'User profile not found. Please complete your profile first.' },\n        { status: 400 }\n      )\n    }\n\n    console.log('‚úÖ User verified in users table:', existingUser.id)\n\n    // Ensure the seller_id matches the authenticated user\n    if (seller_id && seller_id !== user.id) {\n      return NextResponse.json(\n        { error: 'Cannot create listing for another user' },\n        { status: 403 }\n      )\n    }\n\n    // Create main listing with authenticated user as seller\n    const { data: listing, error: listingError } = await supabase\n      .from('listings')\n      .insert({\n        title,\n        description,\n        price: parseFloat(price),\n        currency: currency || 'RWF',\n        price_type,\n        category,\n        transaction_type,\n        status: 'available',\n        location,\n        seller_id: user.id, // Use authenticated user's ID\n        commission_rate: commission_rate,\n        commission_agreed,\n        featured,\n        promoted,\n        views: 0,\n        likes: 0,\n        visit_fee_enabled: visit_fee_enabled ?? true,\n        visit_fee_amount: visit_fee_amount ?? 15000,\n        visit_fee_payment_methods: visit_fee_payment_methods ?? {}\n      })\n      .select()\n      .single()\n\n    if (listingError) {\n      console.error('Listing creation error:', listingError)\n      return NextResponse.json(\n        { error: listingError.message },\n        { status: 500 }\n      )\n    }\n\n    return NextResponse.json({\n      success: true,\n      data: listing\n    })\n\n  } catch (error: any) {\n    console.error('Create listing error:', error)\n    return NextResponse.json(\n      { error: error.message || 'Failed to create listing' },\n      { status: 500 }\n    )\n  }\n}\n"],"names":[],"mappings":";;;;;;AAAA;AACA;;;AAEO,eAAe,IAAI,OAAoB;IAC5C,IAAI;QACF,oEAAoE;QACpE,MAAM,WAAW,IAAA,gMAAY,gFAE3B,QAAQ,GAAG,CAAC,yBAAyB;QAGvC,uBAAuB;QACvB,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,QAAQ,GAAG;QAC5C,MAAM,WAAW,aAAa,GAAG,CAAC;QAClC,MAAM,QAAQ,SAAS,aAAa,GAAG,CAAC,YAAY;QACpD,MAAM,SAAS,SAAS,aAAa,GAAG,CAAC,aAAa;QAEtD,QAAQ,GAAG,CAAC,qCAAqC;YAAE;YAAU;YAAO;QAAO;QAE3E,cAAc;QACd,IAAI,QAAQ,SACT,IAAI,CAAC,YACL,MAAM,CAAC,CAAC;;;;;;;;;;;;;;;;MAgBT,CAAC,EACA,EAAE,CAAC,UAAU,aACb,KAAK,CAAC,cAAc;YAAE,WAAW;QAAM,GACvC,KAAK,CAAC,QAAQ,SAAS,QAAQ;QAElC,kCAAkC;QAClC,IAAI,YAAY,aAAa,OAAO;YAClC,QAAQ,MAAM,EAAE,CAAC,YAAY;QAC/B;QAEA,MAAM,EAAE,MAAM,QAAQ,EAAE,KAAK,EAAE,GAAG,MAAM;QAExC,IAAI,OAAO;YACT,QAAQ,KAAK,CAAC,8BAA8B;YAC5C,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO,MAAM,OAAO;YAAC,GACvB;gBAAE,QAAQ;YAAI;QAElB;QAEA,QAAQ,GAAG,CAAC,CAAC,QAAQ,EAAE,UAAU,UAAU,EAAE,SAAS,CAAC;QAEvD,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,MAAM,YAAY,EAAE;YACpB,OAAO,UAAU,UAAU;QAC7B;IAEF,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,yBAAyB;QACvC,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO,MAAM,OAAO,IAAI;QAA2B,GACrD;YAAE,QAAQ;QAAI;IAElB;AACF;AAEO,eAAe,KAAK,OAAoB;IAC7C,IAAI;QACF,oEAAoE;QACpE,MAAM,WAAW,IAAA,gMAAY,gFAE3B,QAAQ,GAAG,CAAC,yBAAyB;QAGvC,qCAAqC;QACrC,MAAM,gBAAgB,QAAQ,OAAO,CAAC,GAAG,CAAC;QAC1C,IAAI,CAAC,eAAe;YAClB,QAAQ,GAAG,CAAC;YACZ,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAgC,GACzC;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,QAAQ,cAAc,OAAO,CAAC,WAAW;QAE/C,oCAAoC;QACpC,MAAM,EAAE,MAAM,EAAE,IAAI,EAAE,EAAE,OAAO,SAAS,EAAE,GAAG,MAAM,SAAS,IAAI,CAAC,OAAO,CAAC;QAEzE,IAAI,aAAa,CAAC,MAAM;YACtB,QAAQ,KAAK,CAAC,8BAA8B;YAC5C,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;gBAA4B,SAAS,WAAW;YAAQ,GACjE;gBAAE,QAAQ;YAAI;QAElB;QAEA,QAAQ,GAAG,CAAC,yBAAyB,KAAK,KAAK;QAE/C,MAAM,OAAO,MAAM,QAAQ,IAAI;QAC/B,QAAQ,GAAG,CAAC,qBAAqB;QAEjC,MAAM,EACJ,KAAK,EACL,WAAW,EACX,KAAK,EACL,QAAQ,EACR,UAAU,EACV,QAAQ,EACR,gBAAgB,EAChB,QAAQ,EACR,SAAS,EACT,iBAAiB,EACjB,gBAAgB,EAChB,yBAAyB,EACzB,kBAAkB,IAAI,EACtB,iBAAiB,EACjB,WAAW,KAAK,EAChB,WAAW,KAAK,EACjB,GAAG;QAEJ,QAAQ,GAAG,CAAC;QACZ,QAAQ,GAAG,CAAC,YAAY;QACxB,QAAQ,GAAG,CAAC,kBAAkB;QAC9B,QAAQ,GAAG,CAAC,YAAY;QACxB,QAAQ,GAAG,CAAC,eAAe;QAC3B,QAAQ,GAAG,CAAC,gBAAgB;QAE5B,sDAAsD;QACtD,MAAM,iBAAiB;YACrB;gBAAE,KAAK;gBAAS,OAAO;YAAQ;YAC/B;gBAAE,KAAK;gBAAe,OAAO;YAAc;YAC3C;gBAAE,KAAK;gBAAS,OAAO;YAAQ;YAC/B;gBAAE,KAAK;gBAAY,OAAO;YAAW;YACrC;gBAAE,KAAK;gBAAa,OAAO;YAAY;SACxC;QAED,MAAM,gBAAgB,eACnB,MAAM,CAAC,CAAA,QAAS,CAAC,IAAI,CAAC,MAAM,GAAG,CAAC,EAChC,GAAG,CAAC,CAAA,QAAS,MAAM,KAAK;QAE3B,IAAI,cAAc,MAAM,GAAG,GAAG;YAC5B,QAAQ,KAAK,CAAC,8BAA8B;YAC5C,OAAO,gJAAY,CAAC,IAAI,CACtB;gBACE,OAAO;gBACP,eAAe;gBACf,SAAS,CAAC,gBAAgB,EAAE,cAAc,IAAI,CAAC,OAAO;YACxD,GACA;gBAAE,QAAQ;YAAI;QAElB;QAEA,wCAAwC;QACxC,IAAI,MAAM,WAAW,KAAK,KAAK,MAAM,WAAW,KAAK,KAAK,KAAK,GAAG;YAChE,QAAQ,KAAK,CAAC,oBAAoB,KAAK,KAAK;YAC5C,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAwC,GACjD;gBAAE,QAAQ;YAAI;QAElB;QAEA,4CAA4C;QAC5C,MAAM,EAAE,MAAM,YAAY,EAAE,OAAO,cAAc,EAAE,GAAG,MAAM,SACzD,IAAI,CAAC,SACL,MAAM,CAAC,MACP,EAAE,CAAC,MAAM,KAAK,EAAE,EAChB,MAAM;QAET,IAAI,kBAAkB,CAAC,cAAc;YACnC,QAAQ,KAAK,CAAC,oCAAoC;YAClD,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAA8D,GACvE;gBAAE,QAAQ;YAAI;QAElB;QAEA,QAAQ,GAAG,CAAC,mCAAmC,aAAa,EAAE;QAE9D,sDAAsD;QACtD,IAAI,aAAa,cAAc,KAAK,EAAE,EAAE;YACtC,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAyC,GAClD;gBAAE,QAAQ;YAAI;QAElB;QAEA,wDAAwD;QACxD,MAAM,EAAE,MAAM,OAAO,EAAE,OAAO,YAAY,EAAE,GAAG,MAAM,SAClD,IAAI,CAAC,YACL,MAAM,CAAC;YACN;YACA;YACA,OAAO,WAAW;YAClB,UAAU,YAAY;YACtB;YACA;YACA;YACA,QAAQ;YACR;YACA,WAAW,KAAK,EAAE;YAClB,iBAAiB;YACjB;YACA;YACA;YACA,OAAO;YACP,OAAO;YACP,mBAAmB,qBAAqB;YACxC,kBAAkB,oBAAoB;YACtC,2BAA2B,6BAA6B,CAAC;QAC3D,GACC,MAAM,GACN,MAAM;QAET,IAAI,cAAc;YAChB,QAAQ,KAAK,CAAC,2BAA2B;YACzC,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO,aAAa,OAAO;YAAC,GAC9B;gBAAE,QAAQ;YAAI;QAElB;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,MAAM;QACR;IAEF,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,yBAAyB;QACvC,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO,MAAM,OAAO,IAAI;QAA2B,GACrD;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}