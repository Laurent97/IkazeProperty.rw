{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///D:/Apps/IkazeProperty.rw/src/app/api/inquiries/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\nimport { createClient } from '@supabase/supabase-js'\nimport type { Database } from '@/types/database'\n\n// Create supabase client for database operations\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL\nconst supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY\n\nif (!supabaseUrl || !supabaseServiceKey) {\n  throw new Error('Missing Supabase environment variables')\n}\n\nconst supabase = createClient(supabaseUrl, supabaseServiceKey)\n\nasync function getCurrentUser(request: NextRequest) {\n  const userSupabase = createClient(supabaseUrl!, supabaseServiceKey!)\n  \n  const authHeader = request.headers.get('authorization')\n  if (!authHeader) return null\n  \n  const token = authHeader.replace('Bearer ', '')\n  \n  // Validate the JWT token using getUser with service role key\n  const { data: { user }, error } = await userSupabase.auth.getUser(token)\n  \n  if (error || !user) {\n    console.error('Auth validation error:', error?.message)\n    return null\n  }\n  return user\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const currentUser = await getCurrentUser(request)\n    if (!currentUser) {\n      return NextResponse.json(\n        { error: 'Authentication required. Please log in and try again.' },\n        { status: 401 }\n      )\n    }\n\n    const { listing_id, message } = await request.json()\n\n    if (!listing_id || !message) {\n      return NextResponse.json(\n        { error: 'Listing ID and message are required' },\n        { status: 400 }\n      )\n    }\n\n    // Get listing details\n    const { data: listing, error: listingError } = await supabase\n      .from('listings')\n      .select('seller_id, title')\n      .eq('id', listing_id)\n      .single() as { data: { seller_id: string; title: string } | null, error: any }\n\n    if (listingError || !listing) {\n      return NextResponse.json(\n        { error: 'Listing not found' },\n        { status: 404 }\n      )\n    }\n\n    // Check if user is not the seller\n    if (listing.seller_id === currentUser.id) {\n      return NextResponse.json(\n        { error: 'Cannot inquire about your own listing' },\n        { status: 400 }\n      )\n    }\n\n    // Check if inquiry already exists\n    const { data: existingInquiry } = await supabase\n      .from('inquiries')\n      .select('id')\n      .eq('listing_id', listing_id)\n      .eq('buyer_id', currentUser.id)\n      .eq('status', 'pending')\n      .single()\n\n    if (existingInquiry) {\n      return NextResponse.json(\n        { error: 'You already have a pending inquiry for this listing' },\n        { status: 400 }\n      )\n    }\n\n    // Create inquiry\n    const { data: inquiry, error: inquiryError } = await supabase\n      .from('inquiries')\n      .insert({\n        listing_id,\n        buyer_id: currentUser.id,\n        seller_id: listing.seller_id,\n        message,\n        status: 'pending'\n      } as any)\n      .select()\n      .single()\n\n    if (inquiryError) {\n      return NextResponse.json(\n        { error: 'Failed to create inquiry' },\n        { status: 500 }\n      )\n    }\n\n    return NextResponse.json({\n      success: true,\n      data: inquiry\n    })\n  } catch (error) {\n    console.error('Inquiry creation error:', error)\n    return NextResponse.json(\n      { error: 'Internal server error' },\n      { status: 500 }\n    )\n  }\n}\n\nexport async function GET(request: NextRequest) {\n  try {\n    const currentUser = await getCurrentUser(request)\n    if (!currentUser) {\n      return NextResponse.json(\n        { error: 'Authentication required' },\n        { status: 401 }\n      )\n    }\n\n    const { searchParams } = new URL(request.url)\n    const status = searchParams.get('status')\n    const role = searchParams.get('role') // 'buyer' or 'seller'\n\n    let query = supabase\n      .from('inquiries')\n      .select('*')\n      .order('created_at', { ascending: false })\n\n    // Filter by user role\n    if (role === 'buyer') {\n      query = query.eq('buyer_id', currentUser.id)\n    } else if (role === 'seller') {\n      query = query.eq('seller_id', currentUser.id)\n    } else {\n      // Admin can see all inquiries\n      const { data: userProfile } = await supabase\n        .from('users')\n        .select('role')\n        .eq('id', currentUser.id)\n        .single()\n\n      if (userProfile?.role !== 'admin') {\n        return NextResponse.json(\n          { error: 'Insufficient permissions' },\n          { status: 403 }\n        )\n      }\n    }\n\n    // Filter by status\n    if (status) {\n      query = query.eq('status', status)\n    }\n\n    const { data: inquiries, error } = await query\n\n    if (error) {\n      return NextResponse.json(\n        { error: 'Failed to fetch inquiries' },\n        { status: 500 }\n      )\n    }\n\n    // Fetch listing data for each inquiry\n    const inquiriesWithListings = await Promise.all(\n      (inquiries || []).map(async (inquiry) => {\n        console.log('üîç Processing inquiry:', {\n          inquiryId: inquiry.id,\n          listingId: inquiry.listing_id,\n          listingIdType: typeof inquiry.listing_id\n        })\n        \n        if (inquiry.listing_id) {\n          const { data: listing, error: listingError } = await supabase\n            .from('listings')\n            .select('id, title, category, price')\n            .eq('id', inquiry.listing_id)\n            .single()\n          \n          console.log('üìã Listing fetch result:', {\n            listingId: inquiry.listing_id,\n            listing,\n            error: listingError\n          })\n          \n          return {\n            ...inquiry,\n            listings: listing\n          }\n        }\n        \n        console.log('‚ö†Ô∏è No listing_id for inquiry:', inquiry.id)\n        return {\n          ...inquiry,\n          listings: null\n        }\n      })\n    )\n\n    return NextResponse.json({\n      success: true,\n      data: inquiriesWithListings\n    })\n  } catch (error) {\n    console.error('Inquiry fetch error:', error)\n    return NextResponse.json(\n      { error: 'Internal server error' },\n      { status: 500 }\n    )\n  }\n}\n\nexport async function PUT(request: NextRequest) {\n  try {\n    const currentUser = await getCurrentUser(request)\n    if (!currentUser) {\n      return NextResponse.json(\n        { error: 'Authentication required. Please log in and try again.' },\n        { status: 401 }\n      )\n    }\n\n    // Check if user is admin\n    const { data: userProfile } = await supabase\n      .from('users')\n      .select('role')\n      .eq('id', currentUser.id)\n      .single()\n\n    if (userProfile?.role !== 'admin') {\n      return NextResponse.json(\n        { error: 'Insufficient permissions. Admin access required.' },\n        { status: 403 }\n      )\n    }\n\n    const { inquiry_id, status, admin_notes } = await request.json()\n\n    console.log('PUT request data:', { inquiry_id, status, admin_notes })\n\n    if (!inquiry_id || !status) {\n      return NextResponse.json(\n        { error: 'Inquiry ID and status are required' },\n        { status: 400 }\n      )\n    }\n\n    // Update inquiry\n    const { data: inquiry, error } = await supabase\n      .from('inquiries')\n      .update({ status, admin_notes })\n      .eq('id', inquiry_id)\n      .select()\n      .single()\n\n    console.log('Database update result:', { inquiry, error })\n\n    if (error) {\n      console.error('Database update error:', error)\n      return NextResponse.json(\n        { error: `Failed to update inquiry: ${error.message}` },\n        { status: 500 }\n      )\n    }\n\n    // If approved, create a transaction record\n    if (status === 'approved') {\n      const { data: listing } = await supabase\n        .from('listings')\n        .select('price, commission_rate')\n        .eq('id', inquiry.listing_id)\n        .single()\n\n      if (listing) {\n        const commission_amount = Math.round(listing.price * listing.commission_rate)\n        \n        await supabase\n          .from('transactions')\n          .insert({\n            listing_id: inquiry.listing_id,\n            buyer_id: inquiry.buyer_id,\n            seller_id: inquiry.seller_id,\n            amount: listing.price,\n            commission_amount,\n            commission_rate: listing.commission_rate,\n            status: 'pending'\n          })\n      }\n    }\n\n    return NextResponse.json({\n      success: true,\n      data: inquiry\n    })\n  } catch (error) {\n    console.error('Inquiry update error:', error)\n    return NextResponse.json(\n      { error: `Internal server error: ${error instanceof Error ? error.message : 'Unknown error'}` },\n      { status: 500 }\n    )\n  }\n}\n"],"names":[],"mappings":"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"}}]
}