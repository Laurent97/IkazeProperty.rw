{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///D:/Apps/IkazeProperty.rw/src/app/api/inquiries/%5Bid%5D/chat/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\nimport { createClient } from '@supabase/supabase-js'\n\n// Create supabase client for database operations\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL\nconst supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY\n\nif (!supabaseUrl || !supabaseServiceKey) {\n  throw new Error('Missing Supabase environment variables')\n}\n\nconst supabase = createClient(supabaseUrl, supabaseServiceKey)\n\nasync function getCurrentUser(request: NextRequest) {\n  const userSupabase = createClient(supabaseUrl!, supabaseServiceKey!)\n  \n  const authHeader = request.headers.get('authorization')\n  if (!authHeader) return null\n  \n  const token = authHeader.replace('Bearer ', '')\n  \n  // Validate the JWT token using getUser with service role key\n  const { data: { user }, error } = await userSupabase.auth.getUser(token)\n  \n  if (error || !user) {\n    console.error('Auth validation error:', error?.message)\n    return null\n  }\n  return user\n}\n\n// Create inquiry_chats table if it doesn't exist\nasync function ensureChatsTable() {\n  try {\n    // Try to select from the table to see if it exists\n    const { error } = await supabase\n      .from('inquiry_chats')\n      .select('id')\n      .limit(1)\n    \n    if (error && error.code === 'PGRST116') {\n      // Table doesn't exist, return false to indicate it needs to be created\n      console.log('inquiry_chats table does not exist')\n      return false\n    }\n    \n    return true\n  } catch (error) {\n    console.error('Error checking chats table:', error)\n    return false\n  }\n}\n\nexport async function GET(\n  request: NextRequest,\n  context: { params: Promise<{ id: string }> }\n) {\n  const { id: inquiryId } = await context.params\n  \n  try {\n    const currentUser = await getCurrentUser(request)\n    if (!currentUser) {\n      return NextResponse.json(\n        { error: 'Authentication required. Please log in and try again.' },\n        { status: 401 }\n      )\n    }\n\n    // Check if user is admin or the customer who sent the inquiry\n    const { data: inquiry, error: inquiryError } = await supabase\n      .from('inquiries')\n      .select('buyer_id, seller_id')\n      .eq('id', inquiryId)\n      .single()\n\n    if (inquiryError || !inquiry) {\n      return NextResponse.json(\n        { error: 'Inquiry not found' },\n        { status: 404 }\n      )\n    }\n\n    // Check if user is admin or the buyer\n    const { data: userProfile } = await supabase\n      .from('users')\n      .select('role')\n      .eq('id', currentUser.id)\n      .single()\n\n    const isAdmin = userProfile?.role === 'admin'\n    const isBuyer = currentUser.id === inquiry.buyer_id\n\n    if (!isAdmin && !isBuyer) {\n      return NextResponse.json(\n        { error: 'Insufficient permissions' },\n        { status: 403 }\n      )\n    }\n\n    // Ensure chats table exists\n    const tableExists = await ensureChatsTable()\n    if (!tableExists) {\n      return NextResponse.json({\n        success: true,\n        data: [],\n        message: 'Chat table not set up. Please contact administrator.'\n      })\n    }\n\n    // Fetch chat messages for this inquiry\n    const { data: messages, error } = await supabase\n      .from('inquiry_chats')\n      .select('*')\n      .eq('inquiry_id', inquiryId)\n      .order('created_at', { ascending: true })\n\n    if (error) {\n      console.error('Error fetching messages:', error)\n      return NextResponse.json(\n        { error: 'Failed to fetch messages' },\n        { status: 500 }\n      )\n    }\n\n    return NextResponse.json({\n      success: true,\n      data: messages || []\n    })\n  } catch (error) {\n    console.error('Chat fetch error:', error)\n    return NextResponse.json(\n      { error: `Internal server error: ${error instanceof Error ? error.message : 'Unknown error'}` },\n      { status: 500 }\n    )\n  }\n}\n\nexport async function POST(\n  request: NextRequest,\n  context: { params: Promise<{ id: string }> }\n) {\n  const { id: inquiryId } = await context.params\n  \n  try {\n    const currentUser = await getCurrentUser(request)\n    if (!currentUser) {\n      return NextResponse.json(\n        { error: 'Authentication required. Please log in and try again.' },\n        { status: 401 }\n      )\n    }\n\n    const { message, sender } = await request.json()\n\n    console.log('üìù Message data:', { inquiryId, sender, messageLength: message?.length })\n\n    if (!message || !sender) {\n      return NextResponse.json(\n        { error: 'Message and sender are required' },\n        { status: 400 }\n      )\n    }\n\n    // Validate sender\n    if (sender !== 'admin' && sender !== 'customer') {\n      return NextResponse.json(\n        { error: 'Invalid sender type' },\n        { status: 400 }\n      )\n    }\n\n    // Check if user is admin or the customer who sent the inquiry\n    const { data: inquiry, error: inquiryError } = await supabase\n      .from('inquiries')\n      .select('buyer_id, seller_id')\n      .eq('id', inquiryId)\n      .single()\n\n    if (inquiryError || !inquiry) {\n      return NextResponse.json(\n        { error: 'Inquiry not found' },\n        { status: 404 }\n      )\n    }\n\n    // Check permissions\n    const { data: userProfile } = await supabase\n      .from('users')\n      .select('role')\n      .eq('id', currentUser.id)\n      .single()\n\n    const isAdmin = userProfile?.role === 'admin'\n    const isBuyer = currentUser.id === inquiry.buyer_id\n\n    // Admin can send as 'admin', buyer can send as 'customer'\n    if (sender === 'admin' && !isAdmin) {\n      return NextResponse.json(\n        { error: 'Only admins can send messages as admin' },\n        { status: 403 }\n      )\n    }\n\n    if (sender === 'customer' && !isBuyer) {\n      return NextResponse.json(\n        { error: 'Only the inquiry buyer can send messages as customer' },\n        { status: 403 }\n      )\n    }\n\n    // Ensure chats table exists\n    const tableExists = await ensureChatsTable()\n    if (!tableExists) {\n      return NextResponse.json(\n        { error: 'Chat table not set up. Please contact administrator.' },\n        { status: 503 }\n      )\n    }\n\n    // Create the message\n    const { data: chatMessage, error } = await supabase\n      .from('inquiry_chats')\n      .insert({\n        inquiry_id: inquiryId,\n        sender_id: currentUser.id,\n        sender_type: sender,\n        message: message.trim(),\n        created_at: new Date().toISOString()\n      })\n      .select()\n      .single()\n\n    if (error) {\n      console.error('Error creating message:', error)\n      return NextResponse.json(\n        { error: `Failed to send message: ${error.message}` },\n        { status: 500 }\n      )\n    }\n\n    return NextResponse.json({\n      success: true,\n      data: chatMessage\n    })\n  } catch (error) {\n    console.error('Chat send error:', error)\n    return NextResponse.json(\n      { error: `Internal server error: ${error instanceof Error ? error.message : 'Unknown error'}` },\n      { status: 500 }\n    )\n  }\n}\n"],"names":[],"mappings":"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"}}]
}