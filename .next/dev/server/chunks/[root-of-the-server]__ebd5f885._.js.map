{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///D:/Apps/IkazeProperty.rw/src/lib/supabase.ts"],"sourcesContent":["import { createClient } from '@supabase/supabase-js';\n\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\nconst supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;\nconst supabaseServiceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\n\nif (!supabaseUrl || !supabaseAnonKey) {\n  throw new Error('Missing Supabase environment variables. Please check your .env.local file.');\n}\n\nexport const supabase = createClient(supabaseUrl, supabaseAnonKey);\n\n// For server-side operations\nexport const supabaseAdmin = supabaseServiceRoleKey \n  ? createClient(supabaseUrl, supabaseServiceRoleKey)\n  : supabase;\n"],"names":[],"mappings":";;;;;;AAAA;;AAEA,MAAM;AACN,MAAM;AACN,MAAM,yBAAyB,QAAQ,GAAG,CAAC,yBAAyB;AAEpE;;AAIO,MAAM,WAAW,IAAA,gMAAY,EAAC,aAAa;AAG3C,MAAM,gBAAgB,yBACzB,IAAA,gMAAY,EAAC,aAAa,0BAC1B"}},
    {"offset": {"line": 65, "column": 0}, "map": {"version":3,"sources":["file:///D:/Apps/IkazeProperty.rw/src/app/api/settings/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { createClient } from '@supabase/supabase-js';\nimport { supabaseAdmin } from '@/lib/supabase';\n\nexport async function GET(request: NextRequest) {\n  try {\n    const authorization = request.headers.get('authorization');\n    if (!authorization) {\n      return NextResponse.json({ error: 'Authorization header required' }, { status: 401 });\n    }\n\n    const token = authorization.replace('Bearer ', '');\n    const supabase = createClient(\n      process.env.NEXT_PUBLIC_SUPABASE_URL!,\n      process.env.SUPABASE_SERVICE_ROLE_KEY!\n    );\n\n    const { data: { user }, error: authError } = await supabase.auth.getUser(token);\n    if (authError || !user) {\n      return NextResponse.json({ error: 'Invalid or expired token' }, { status: 401 });\n    }\n\n    const { data: userData } = await supabaseAdmin\n      .from('users')\n      .select('role')\n      .eq('id', user.id)\n      .single();\n\n    if (userData?.role !== 'admin') {\n      return NextResponse.json({ error: 'Insufficient permissions' }, { status: 403 });\n    }\n\n    const { data, error } = await supabaseAdmin\n      .from('settings')\n      .select('*')\n      .single();\n\n    if (error) {\n      console.log('Settings fetch error:', error);\n      if (error.code === 'PGRST116') {\n        // Table doesn't exist or no rows, return default settings\n        console.log('Settings table not found, returning defaults');\n        return NextResponse.json({ \n          settings: {\n            id: 1,\n            commission_rate: 5,\n            min_commission: 1000,\n            max_commission: 100000,\n            payment_methods: ['mobile_money', 'bank_transfer', 'cash'],\n            mobile_money_providers: ['mtn', 'airtel'],\n            bank_details: {},\n            mobile_money_details: {},\n            visit_fee_enabled: true,\n            visit_fee_amount: 15000,\n            visit_fee_payment_methods: {},\n            auto_approve_listings: false,\n            require_email_verification: true,\n            enable_notifications: true,\n            created_at: new Date().toISOString(),\n            updated_at: new Date().toISOString()\n          }\n        });\n      }\n      // For other errors, still return defaults to avoid breaking the frontend\n      console.log('Database error, returning default settings');\n      return NextResponse.json({ \n        settings: {\n          id: 1,\n          commission_rate: 5,\n          min_commission: 1000,\n          max_commission: 100000,\n          payment_methods: ['mobile_money', 'bank_transfer', 'cash'],\n          mobile_money_providers: ['mtn', 'airtel'],\n          bank_details: {},\n          mobile_money_details: {},\n          visit_fee_enabled: true,\n          visit_fee_amount: 15000,\n          visit_fee_payment_methods: {},\n          auto_approve_listings: false,\n          require_email_verification: true,\n          enable_notifications: true,\n          created_at: new Date().toISOString(),\n          updated_at: new Date().toISOString()\n        }\n      });\n    }\n\n    // If we got data, return it\n    const settingsData = data || {\n      id: 1,\n      commission_rate: 5,\n      min_commission: 1000,\n      max_commission: 100000,\n      payment_methods: ['mobile_money', 'bank_transfer', 'cash'],\n      mobile_money_providers: ['mtn', 'airtel'],\n      bank_details: {},\n      mobile_money_details: {},\n      visit_fee_enabled: true,\n      visit_fee_amount: 15000,\n      visit_fee_payment_methods: {},\n      auto_approve_listings: false,\n      require_email_verification: true,\n      enable_notifications: true,\n      created_at: new Date().toISOString(),\n      updated_at: new Date().toISOString()\n    };\n\n    return NextResponse.json({ settings: settingsData });\n  } catch (error: any) {\n    console.error('Settings fetch error:', error);\n    return NextResponse.json(\n      { error: 'Failed to fetch settings' },\n      { status: 500 }\n    );\n  }\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const authorization = request.headers.get('authorization');\n    if (!authorization) {\n      return NextResponse.json({ error: 'Authorization header required' }, { status: 401 });\n    }\n\n    const token = authorization.replace('Bearer ', '');\n    const supabase = createClient(\n      process.env.NEXT_PUBLIC_SUPABASE_URL!,\n      process.env.SUPABASE_SERVICE_ROLE_KEY!\n    );\n\n    const { data: { user }, error: authError } = await supabase.auth.getUser(token);\n    if (authError || !user) {\n      return NextResponse.json({ error: 'Invalid or expired token' }, { status: 401 });\n    }\n\n    const { data: userData } = await supabaseAdmin\n      .from('users')\n      .select('role')\n      .eq('id', user.id)\n      .single();\n\n    if (userData?.role !== 'admin') {\n      return NextResponse.json({ error: 'Insufficient permissions' }, { status: 403 });\n    }\n\n    const body = await request.json();\n    console.log('Settings POST request body:', body);\n\n    // Validate required fields\n    if (!body || typeof body !== 'object') {\n      return NextResponse.json(\n        { error: 'Invalid request body' },\n        { status: 400 }\n      );\n    }\n\n    const { error } = await supabaseAdmin\n      .from('settings')\n      .upsert({\n        id: 1,\n        ...body,\n        updated_at: new Date().toISOString()\n      });\n\n    if (error) {\n      console.error('Supabase upsert error:', error);\n      if (error.code === 'PGRST204' || error.code === 'PGRST116') {\n        // Table doesn't exist, return success with default values\n        console.log('Settings table does not exist, returning success with defaults');\n        return NextResponse.json({ \n          success: true,\n          message: 'Settings saved successfully (table will be created on next deployment)',\n          settings: {\n            id: 1,\n            commission_rate: 5,\n            min_commission: 1000,\n            max_commission: 100000,\n            payment_methods: ['mobile_money', 'bank_transfer', 'cash'],\n            mobile_money_providers: ['mtn', 'airtel'],\n            bank_details: {},\n            mobile_money_details: {},\n            visit_fee_enabled: true,\n            visit_fee_amount: 15000,\n            visit_fee_payment_methods: {},\n            auto_approve_listings: false,\n            require_email_verification: true,\n            enable_notifications: true,\n            created_at: new Date().toISOString(),\n            updated_at: new Date().toISOString()\n          }\n        });\n      }\n      return NextResponse.json({ error: error.message }, { status: 500 });\n    }\n\n    console.log('Settings updated successfully');\n    return NextResponse.json({ success: true });\n  } catch (error: any) {\n    console.error('Settings update error:', error);\n    return NextResponse.json(\n      { error: 'Failed to update settings' },\n      { status: 500 }\n    );\n  }\n}\n\nexport async function PUT(request: NextRequest) {\n  return POST(request); // Handle PUT the same way as POST\n}\n"],"names":[],"mappings":"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"}}]
}